<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Editor CSV - PlayListLuglio2025</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@octokit/rest/dist-web/index.js"></script>
  <link href="https://unpkg.com/tabulator-tables@5.6.1/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://unpkg.com/tabulator-tables@5.6.1/dist/js/tabulator.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f7f7f7;
    }
    h2 {
      color: #333;
    }
    #csv-table {
      margin-bottom: 20px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background-color: #007acc;
      color: white;
      border: none;
      border-radius: 5px;
    }
    button:hover {
      background-color: #005fa3;
    }
  </style>
</head>
<body>
  <h2>üéµ Editor CSV: PlayListLuglio2025</h2>
  <div id="csv-table"></div>
  <button onclick="commitCSV()">üíæ Salva su GitHub</button>

  <script>
    // CONFIGURAZIONE
    const GITHUB_TOKEN = "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";
    const REPO_OWNER = "DarkcROW99X";
    const REPO_NAME = "PlayList";
    const FILE_PATH = "PlayListLuglio2025.csv";
    const BRANCH = "main";

    let table;
    let fileSha = null;

    const octokit = new Octokit.Octokit({ auth: GITHUB_TOKEN });

    async function loadCSV() {
      try {
        const res = await octokit.repos.getContent({
          owner: REPO_OWNER,
          repo: REPO_NAME,
          path: FILE_PATH,
          ref: BRANCH
        });

        fileSha = res.data.sha;
        const csvContent = atob(res.data.content);

        const parsed = Papa.parse(csvContent, { header: true });

        table = new Tabulator("#csv-table", {
          data: parsed.data,
          autoColumns: true,
          layout: "fitDataStretch",
        });
      } catch (err) {
        alert("Errore nel caricamento del CSV: " + err.message);
        console.error(err);
      }
    }
    
async function commitCSV() {
  try {
    if (!table) {
      alert("‚ö†Ô∏è La tabella non √® stata ancora caricata. Riprova pi√π tardi.");
      return;
    }

    const updatedData = table.getData();
    const newCsv = Papa.unparse(updatedData);
    const encoded = btoa(newCsv);

    const commitResult = await octokit.repos.createOrUpdateFileContents({
      owner: REPO_OWNER,
      repo: REPO_NAME,
      path: FILE_PATH,
      message: "üîÑ Aggiornamento automatico da editor web",
      content: encoded,
      sha: fileSha,
      branch: BRANCH,
    });

    alert("‚úÖ CSV aggiornato su GitHub!");
    loadCSV(); // Ricarica per aggiornare SHA


  } catch (err) {
    alert("Errore durante il salvataggio: " + err.message);
    console.error(err);
  }
}

   
  </script>
</body>
</html>
